<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BJCP Score Sheet</title>

  <meta charset="utf-8">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.0/font/bootstrap-icons.css" />
  <style>
    main {
      padding-bottom: 3em;
    }

    .nav-link {
      padding: 0.5em;
      font-size: 80%;
    }

    label {
      font-weight: bold;
    }

    .categoryGroup {
      margin-top: 1em;
    }

    form {
      border: 1px solid #fafafa;
      padding: 10px;
    }
  </style>
</head>

<body>
  <main class="container">
    <h1 class="text-center">BJCP Score Sheet</h1>
    <form>
      <div class="categoryGroup">
        <div class="row text-start">
          <label for="aromaScore" class="col-sm-6 col-form-label">Aroma:</label>
          <div class="col-sm-6">
            <input class="form-control text-center" type="number" id="aromaScore" min="1" max="12">
          </div>
        </div>
        <div class="form-floating pt-2 descript-group">
          <textarea spellcheck="false" class="form-control" id="aromaDescript" style="height: 135px">[level] [maltdescriptor] malt
[level] [hopsdescriptor] hops
[level] [yeastdescriptor] fermentation character
[level] [otherdescriptor]</textarea>
          <label for="aromaDescript">Description:</label>
          <ul class="nav">
            <li class="nav-item dropdown" id="aromaLevelDescript"></li>
            <li class="nav-item dropdown" id="maltAromaDescript"></li>
            <li class="nav-item dropdown" id="hopAromaDescript"></li>
            <li class="nav-item dropdown" id="yeastAromaDescript"></li>
            <li class="nav-item dropdown" id="otherAromaDescript"></li>
          </ul>
        </div>
      </div>
      <div class="categoryGroup">
        <div class="row text-start">
          <label for="appearanceScore" class="col-sm-6 col-form-label">Appearance:</label>
          <div class="col-sm-6">
            <input class="form-control text-center" type="number" id="appearanceScore" min="1" max="3">
          </div>
        </div>
        <div class="form-floating pt-2 descript-group">
          <textarea spellcheck="false" class="form-control" id="appearanceDescript" style="height: 110px">[color] [clarity]
[level] [headdescript] [headcolor] head
[level] [otherappearance]</textarea>
          <label for="appearanceDescript">Description:</label>
          <ul class="nav">
            <li class="nav-item dropdown" id="appearanceLevelDescript"></li>
            <li class="nav-item dropdown" id="colorDescript"></li>
            <li class="nav-item dropdown" id="clarityDescript"></li>
            <li class="nav-item dropdown" id="headDescript"></li>
            <li class="nav-item dropdown" id="headColorDescript"></li>
            <li class="nav-item dropdown" id="otherAppearanceDescript"></li>
          </ul>
        </div>
      </div>
      <div class="categoryGroup">
        <div class="row text-start">
          <label for="flavorScore" class="col-sm-6 col-form-label">Flavor:</label>
          <div class="col-sm-6">
            <input class="form-control text-center" type="number" id="flavorScore" min="1" max="20">
          </div>
        </div>
        <div class="form-floating pt-2 descript-group">
          <textarea spellcheck="false" class="form-control" id="flavorDescript" style="height: 185px">[level] [balance] balance
[level] [maltdescriptor] malt
[level] hop bitterness
[level] [hopsdescriptor] hops flavor
[level] [yeastdescriptor] fermentation character
[level] [otherdescriptor]</textarea>
          <label for="flavorDescript">Description:</label>
          <ul class="nav">
            <li class="nav-item dropdown" id="flavorLevelDescript"></li>
            <li class="nav-item dropdown" id="balanceDescript"></li>
            <li class="nav-item dropdown" id="maltFlavorDescript"></li>
            <li class="nav-item dropdown" id="hopFlavorDescript"></li>
            <li class="nav-item dropdown" id="yeastFlavorDescript"></li>
            <li class="nav-item dropdown" id="otherFlavorDescript"></li>
          </ul>
        </div>
      </div>
      <div class="categoryGroup">
        <div class="row text-start">
          <label for="mouthScore" class="col-sm-6 col-form-label">Mouthfeel:</label>
          <div class="col-sm-6">
            <input class="form-control text-center" type="number" id="mouthScore" min="1" max="5">
          </div>
        </div>
        <div class="form-floating pt-2 descript-group">
          <textarea spellcheck="false" class="form-control" id="mouthDescript" style="height: 160px">[bodydescriptor] body
[level] carbination
[level] alcohol warmth
[level] creaminess
[level] astringency</textarea>
          <label for="flavorDescript">Description:</label>
          <ul class="nav">
            <li class="nav-item dropdown" id="mouthLevelDescript"></li>
            <li class="nav-item dropdown" id="bodyDescript"></li>
          </ul>
        </div>
      </div>
      <div class="categoryGroup">
        <div class="row text-start">
          <label for="overallScore" class="col-sm-6 col-form-label">Overall Impression:</label>
          <div class="col-sm-6">
            <input class="form-control text-center" type="number" id="overallScore" min="1" max="10">
          </div>
        </div>
        <div class="form-floating pt-2 descript-group">
          <textarea spellcheck="false" class="form-control" id="overallDescrit" style="height: 160px">Positive comment
Feedback on each style/quality issue
Suggest other category if appropriate</textarea>
          <label for="flavorDescript">Feedback:</label>
        </div>
      </div>
      <div class="categoryGroup">
        <div class="row text-start">
          <label for="totalScore" class="col-sm-6 col-form-label">Total Score:</label>
          <div class="col-sm-6">
            <input class="form-control text-center" type="number" id="totalScore" min="1" max="50" readonly>
          </div>
        </div>
      </div>
    </form>
    <hr>
    <div>
      <h2>Scoring guide</h2>
      <dl>
        <dt>
          Outstanding (45 - 50)
        </dt>
        <dd>
          World-class example of style
        </dd>
        <dt>
          Excellent (38 - 44)
        </dt>
        <dd>
          Exemplifies style well, requires minor fine-tuning
        </dd>
        <dt>
          Very Good (30 - 37)
        </dt>
        <dd>
          Generally within style parameters, some minor flaws
        </dd>
        <dt>
          Good (21 - 29)
        </dt>
        <dd>
          Misses the mark on style and/or minor flaws
        </dd>
        <dt>
          Fair (20 - 14)
        </dt>
        <dd>
          Off flavors, aromas or major style deficiencies
        </dd>
        <dt>
          Fair (13 - 0)
        </dt>
        <dd>
          Major off flavors and aromas dominate
        </dd>
      </dl>
    </div>
  </main>
  <footer></footer>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0"
    crossorigin="anonymous"></script>

    
  <script src="https://cdn.jsdelivr.net/npm/ejs@3.1.8/ejs.min.js"></script>
  <script>

    let keywords = ['level', 'maltdescriptor', 'hopsdescriptor', 'yeastdescriptor', 'otherdescriptor',
                    'color', 'clarity', 'headdescript', 'headcolor', 'otherappearance', 'balance', 'finish',
                    'bodydescriptor'];

    function insert(el, value) {
      let target = el.closest(".descript-group").getElementsByTagName('textarea')[0];
      target.focus();
      let upTo = target.value.substr(0, target.selectionStart);
      let after = target.value.substr(target.selectionEnd);
      target.value = upTo + value + (target.value[target.selectionEnd - 1] == ' ' ? ' ' : "") + after;
      target.selectionStart = upTo.length + value.length;
      target.selectionEnd = upTo.length + value.length;
      console.log(target.selectionStart)
    }

    function textAreaClick(e) {
      let el = e.target;
      let startIndex = el.selectionStart;
      while(startIndex >= 1 && el.value[startIndex - 1].trim() != '' && el.value[startIndex] != '[')
        startIndex--;
      let endIndex = el.selectionStart;
      while(endIndex < el.value.length && el.value[endIndex].trim() != '' && el.value[startIndex - 1] != ']')
        endIndex++;
      let selectWord = el.value.slice(startIndex, endIndex).trim();
      selectWord = selectWord.slice(1, selectWord.length - 1);
      if( keywords.includes(selectWord) ) {
        el.selectionStart = startIndex;
        el.selectionEnd = endIndex;
      }
    }

    function checkSelect(e) {
      let el = e.target;
      if(el !== document.activeElement)
        return;

      let selectWord = el.value.slice(el.selectionStart + 1, el.selectionEnd - 1).trim();
      if( keywords.includes(selectWord) ) {
        let target = el.closest(".descript-group").querySelector('.dropdown-toggle.' + selectWord);
        if(target)
          target.click();
      }
    }

    function stringComp(a, b) {
      return a.toLowerCase().localeCompare(b.toLowerCase());
    }

    let levelList = ['no', 'trace', 'low', 'med', 'medium-high', 'high'];

    let maltList = ['bread', 'bread crust', 'soda cracker', 'toast', 'biscuit', 'graham cracker',
                    'honey', 'caramel', 'toffee', 'dark fruit', 'burnt sugar', 'chocolate',
                    'cocoa', 'earthy', 'smoke', 'rye', 'grainy', 'hay like'];
    maltList = maltList.sort();

    let hopList = ['piney', 'mint', 'herbal', 'floral', 'pear', 'white wine',
                    'earthy', 'black berry', 'berry', 'melon', 'pineapple', 'tropical fruit',
                    'grapefruit', 'orange', 'citrus', 'lime', 'lemon', 'lemon grass',
                    'resinous', 'spicy', 'woody', 'minty', 'oniony', 'vegetal', 'coconut',
                    'catty', 'grassy'];
    hopList = hopList.sort();

    let yeastList = ['fruity', 'pear', 'bubblegum', 'banana', 'clove', 'peppery', 'sour', 'barnyard',
                     'clean sour', 'funky'];
    yeastList = yeastList.sort();

    let otherDescriptList = ['metalic', 'vinegar', 'green apple', 'alcohol', 'buttery', 'DMS',
                    'musty', 'oxidized', 'cardboard', 'skunky', 'plastic', 'band-aid',
                    'medicinal', 'solventy', 'mousy', 'rancid', 'cheesy',
                    'yeasty', 'sulfur', 'cidery', 'sulphur', 'salty', 'sour'];
                    otherDescriptList = otherDescriptList.sort(stringComp);

    let balanceList = ['malty', 'hoppy', 'estery'];

    let colorList = ['straw', 'yellow', 'amber', 'copper', 'brown', 'black'];

    let clarityList = ['brilliant', 'lightly hazy' ,'hazy', 'cloudy', 'opaque'];

    let headList = ['quick fading', 'persistent', 'lasting'];
                     headList = headList.sort();

    let headColorList = ['white', 'ivory', 'beige', 'tan'];

    let otherAppearList = ['legs', 'lacing', 'particulate'];
                     otherAppearList = otherAppearList.sort();

    let bodyList = ['thin', 'medium', 'full', 'body'];


    var template = `
        <a class="nav-link dropdown-toggle <%=className%>" data-bs-toggle="dropdown" href="#" role="button" aria-expanded="false"><%=title%></a>
        <ul class="dropdown-menu">
          <% for(i = 0; i < list.length; i++) { %>
            <li><a class="dropdown-item" onclick="insert(this, '<%=list[i]%>');"><%=list[i]%></a></li>
          <% } %>
        </ul>
      `;

    let levelDesc = ejs.render(template, { list: levelList, className: 'level', title: 'Level' });
    let maltDesc = ejs.render(template, { list: maltList, className: 'maltdescriptor', title: 'Malt' });
    let hopDesc = ejs.render(template, { list: hopList, className: 'hopsdescriptor', title: 'Hops' });
    let yeastDesc = ejs.render(template, { list: yeastList, className: 'yeastdescriptor', title: 'Yeast' });
    let otherDesc = ejs.render(template, { list: otherDescriptList, className: 'otherdescriptor', title: 'Other' });
    let balanceDesc = ejs.render(template, { list: balanceList, className: 'balance', title: 'Balance' });
    let colorDesc = ejs.render(template, { list: colorList, className: 'color', title: 'Color' });
    let clarityDesc = ejs.render(template, { list: clarityList, className: 'clarity', title: 'Clarity' });
    let headDesc = ejs.render(template, { list: headList, className: 'headdescript', title: 'Head' });
    let headColorDesc = ejs.render(template, { list: headColorList, className: 'headcolor', title: 'HeadColor' });
    let otherAppearDesc = ejs.render(template, { list: otherAppearList, className: 'otherappearance', title: 'Other' });
    let bodyDesc = ejs.render(template, { list: bodyList, className: 'bodydescriptor', title: 'Body' });

    document.getElementById('aromaLevelDescript').innerHTML = levelDesc;
    document.getElementById('maltAromaDescript').innerHTML = maltDesc;
    document.getElementById('hopAromaDescript').innerHTML = hopDesc;
    document.getElementById('yeastAromaDescript').innerHTML = yeastDesc;
    document.getElementById('otherAromaDescript').innerHTML = otherDesc;

    document.getElementById('appearanceLevelDescript').innerHTML = levelDesc;
    document.getElementById('colorDescript').innerHTML = colorDesc;
    document.getElementById('clarityDescript').innerHTML = clarityDesc;
    document.getElementById('headDescript').innerHTML = headDesc;
    document.getElementById('headColorDescript').innerHTML = headColorDesc;
    document.getElementById('otherAppearanceDescript').innerHTML = otherAppearDesc;

    document.getElementById('flavorLevelDescript').innerHTML = levelDesc;
    document.getElementById('balanceDescript').innerHTML = balanceDesc;
    document.getElementById('maltFlavorDescript').innerHTML = maltDesc;
    document.getElementById('hopFlavorDescript').innerHTML = hopDesc;
    document.getElementById('yeastFlavorDescript').innerHTML = yeastDesc;
    document.getElementById('otherFlavorDescript').innerHTML = otherDesc;

    document.getElementById('bodyDescript').innerHTML = bodyDesc;
    document.getElementById('mouthLevelDescript').innerHTML = levelDesc;

    let scores = document.querySelectorAll('input[type="number"]:not([id="totalScore"])');
    let totalScoreEl = document.getElementById('totalScore');

    for (var i = 0; i < scores.length; i++) {
      let newElementHTML = `<select class="form-select" id="${scores[i].id}">`;
      for(let j = 1; j <= parseInt(scores[i].getAttribute('max')); j++)
        newElementHTML += `<option>${j}</option>`;
      newElementHTML += '</select>';
      let newElement = document.createElement('div');
      newElement.innerHTML = newElementHTML;
      scores[i].replaceWith(newElement);
    }
    
    scores = document.querySelectorAll('select');
    for (var i = 0; i < scores.length; i++) {
      scores[i].addEventListener('change', (e) => {
        let total = 0;
        for (var j = 0; j < scores.length; j++) {
          let score = 0;
          if(scores[j].value.trim() !== '')
            score = parseInt(scores[j].value);
          total += score;
        }
        totalScoreEl.value = total;
      });

    }

    document.getElementById('aromaDescript').addEventListener('select', checkSelect);
    document.getElementById('aromaDescript').addEventListener('click', textAreaClick);
    document.getElementById('appearanceDescript').addEventListener('select', checkSelect);
    document.getElementById('appearanceDescript').addEventListener('click', textAreaClick);
    document.getElementById('flavorDescript').addEventListener('select', checkSelect);
    document.getElementById('flavorDescript').addEventListener('click', textAreaClick);
    document.getElementById('mouthDescript').addEventListener('select', checkSelect);
    document.getElementById('mouthDescript').addEventListener('click', textAreaClick);
  </script>
</body>
</html>